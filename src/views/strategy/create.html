<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>创建策略</title>
  <meta name="renderer" content="webkit" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0" />
  <link rel="stylesheet" href="../../assets/layui/css/layui.css" media="all" />
  <link rel="stylesheet" href="../../assets/style/index.css" media="all" />
  <link rel="stylesheet" href="../../assets/style/page.css" media="all" />
</head>

<body>
  <div class="common-page createStrategy">
    <div class="layui-tab" lay-filter="pageTab">
      <ul class="layui-tab-title layui-row  step-top-wrap">
        <li class="layui-this layui-col-md4 layui-col-sm4 step-item step-item-first" lay-id="0">
          <i class="step-icon step1"></i>
          <p class="step-text">What:基本信息</p>
        </li>
        <li class="layui-col-md4 layui-col-sm4 step-item" lay-id="1">
          <i class="step-icon  step2"></i>
          <p class="step-text">Who:目标客户群</p>
        </li>
        <li class="layui-col-md4 layui-col-sm4 step-item step-item-last" lay-id="2">
          <i class="step-icon  step3"></i>
          <p class="step-text">How:执行触点</p>
        </li>
      </ul>
      <div class="layui-tab-content">
        <div class="layui-tab-item layui-show">
          <div class="layui-card">
            <div class="layui-card-body">
              <form class="layui-form">
                <div class="layui-form-item">
                  <label class="layui-form-label">策略名称：</label>
                  <div class="layui-input-block">
                    <input type="text" name="prop1" autocomplete="off" class="layui-input">
                  </div>
                </div>
                <div class="layui-form-item">
                  <label class="layui-form-label">关联政策：</label>
                  <div class="layui-input-block">
                    <div class="layui-card">
                      <div class="layui-card-body">
                        <div class="top-wrap clearfix">
                          <span>所有政策</span>
                          <div class="search-btn-wrap layui-inline fr">
                            <input type="text" class="layui-input" placeholder="搜索政策">
                            <i class="layui-icon layui-icon-search" onclick="rendCustWrap()"></i>
                          </div>
                        </div>
                        <div>
                          <form class="layui-form">
                            <div id="choosePolicyWrap"></div>
                          </form>
                          <div id="policy-laypage" class="text-center"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="layui-form-item">
                  <label class="layui-form-label">策略描述：</label>
                  <div class="layui-input-block">
                    <textarea placeholder="请输入内容" name="prop3" class="layui-textarea"></textarea>
                  </div>
                </div>

              </form>
            </div>
          </div>
        </div>
        <div class="layui-tab-item">
          <div class="layui-row layui-col-space10">
            <div class="layui-col-md9 layui-col-sm9">
              <div class="layui-tab layui-tab-card tab2">
                <ul class="layui-tab-title">
                  <li class="layui-this">新增用户群</li>
                  <li>已有用户群</li>
                </ul>
                <div class="layui-tab-content">
                  <div class="layui-tab-item layui-show">
                    <form class="layui-form" wid140>
                      <div class="layui-form-item">

                        <label class="layui-form-label">客户群类型：</label>
                        <div class="layui-input-block">
                          <div class="layui-tab layui-tab-brief custTypeTab" lay-filter="typeTab">
                            <ul class="layui-tab-title">
                              <li>取数模板</li>
                              <li>标签选择</li>
                              <li>总部模型</li>
                              <li class="layui-this">订单数据</li>
                              <li>文件上传</li>
                            </ul>
                            <div class="layui-tab-content">
                              <div class="layui-tab-item ">
                                <div class="layui-card">
                                  <div class="layui-card-body">取数模板</div>
                                </div>
                              </div>
                              <div class="layui-tab-item ">
                                <div class="layui-card">
                                  <div class="layui-card-body">标签选择</div>
                                </div>
                              </div>
                              <div class="layui-tab-item ">
                                <div class="layui-card">
                                  <div class="layui-card-body">总部模型</div>
                                </div>
                              </div>
                              <div class="layui-tab-item layui-show oversizeContent">
                                <div class="layui-card">
                                  <div class="layui-card-body">
                                    <div class="layui-form-item">
                                      <div class="layui-inline">
                                        <label class="layui-form-label">任务类型：</label>
                                        <div class="layui-input-block box-radio">
                                          <input type="radio" name="taskType" value="1" title="催转化" checked="">
                                          <input type="radio" name="taskType" value="2" title="催激活">
                                        </div>
                                      </div>
                                      <div class="layui-inline">
                                        <label class="layui-form-label">充值数据来源：</label>
                                        <div class="layui-input-block ">
                                          <input type="checkbox" name="originType[1]" lay-skin="box" title="人工干预激活"
                                            checked="" />
                                          <input type="checkbox" name="originType[2]" lay-skin="box" title="自主激活" />
                                        </div>
                                      </div>
                                    </div>
                                    <div class="layui-form-item">
                                      <label class="layui-form-label layui-required">预开户前几天(天)：</label>
                                      <div class="layui-input-block">
                                        <input type="text" name="" class="layui-input" lay-verify="required">
                                      </div>
                                    </div>
                                    <div class="layui-form-item">
                                      <label class="layui-form-label">预开户时间：</label>
                                      <div class="layui-inline">
                                        <div class="layui-input-inline">
                                          <input type="text" class="layui-input" id="startDate21"
                                            placeholder="yyyy-MM-dd">
                                        </div>
                                        <div class="layui-form-mid">至</div>
                                        <div class="layui-input-inline">
                                          <input type="text" class="layui-input" id="endDate21"
                                            placeholder="yyyy-MM-dd">
                                        </div>
                                      </div>

                                    </div>
                                    <div class="layui-form-item">
                                      <label class="layui-form-label">签收状态：</label>
                                      <div class="layui-input-block">
                                        <input type="text" name="" class="layui-input">
                                      </div>
                                    </div>
                                    <div class="layui-form-item">
                                      <label class="layui-form-label">签收时间：</label>
                                      <div class="layui-inline">
                                        <div class="layui-input-inline">
                                          <input type="text" class="layui-input" id="startDate22"
                                            placeholder="yyyy-MM-dd">
                                        </div>
                                        <div class="layui-form-mid">至</div>
                                        <div class="layui-input-inline">
                                          <input type="text" class="layui-input" id="endDate22"
                                            placeholder="yyyy-MM-dd">
                                        </div>
                                      </div>
                                    </div>
                                    <div class="layui-form-item">
                                      <label class="layui-form-label">订单状态：</label>
                                      <div class="layui-input-block">
                                        <input type="text" name="" class="layui-input">
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              <div class="layui-tab-item ">
                                <div class="layui-card upload-card">
                                  <div class="layui-card-body">
                                    <div class="layui-upload-drag " id="uploadFile">
                                      <i class="upload-icon"></i>
                                      <p class="upload-text">文件上传</p>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>
                  <div class="layui-tab-item">
                    <div id="selectWrap"></div>
                    <div id="cust-laypage" class="text-center"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="layui-col-md3 layui-col-sm3">
              <div class="layui-tab layui-tab-card tab2" lay-filter="choosedTab">
                <ul class="layui-tab-title">
                  <li class="layui-this">已选</li>
                  <li>排除</li>
                </ul>
                <div class="layui-tab-content">
                  <div class="layui-tab-item layui-show">
                    <div id="choosedCustWrap"></div>
                  </div>
                  <div class="layui-tab-item">
                    <div id="excludeCustWrap"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
        <div class="layui-tab-item">
          <div class="layui-card">
            <div class="layui-card-body">
              <form class="layui-form" wid110>
                <div class="layui-form-item">
                  <label class="layui-form-label">执行周期：</label>
                  <div class="layui-inline">
                    <div class="layui-input-inline">
                      <input type="text" class="layui-input" id="startDate" placeholder="yyyy-MM-dd">
                    </div>
                    <div class="layui-form-mid">-</div>
                    <div class="layui-input-inline">
                      <input type="text" class="layui-input" id="endDate" placeholder="yyyy-MM-dd">
                    </div>
                  </div>
                </div>
                <div class="layui-form-item multi-elem-line">
                  <label class="layui-form-label">触点选择：</label>
                  <div class="layui-inline">
                    <label class="layui-form-mid">当</label>
                    <div class="layui-input-inline">
                      <select name="select1" id="select1"></select>
                    </div>
                    <div class="layui-form-mid">是</div>
                    <div class="layui-input-inline">
                      <select name="select2" id="select2"></select>
                    </div>
                    <div class="layui-form-mid">时，执行</div>
                    <div class="layui-input-inline">
                      <select name="select3" id="select3">
                        <option value="1" selected>线下触点</option>
                      </select>
                    </div>
                    <div class="layui-input-inline">
                      <select name="select4" id="select4" lay-filter="selectChnl">
                        <option value="1" selected>短信</option>
                        <option value="2">人工外呼</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="layui-form-item">
                  <label class="layui-form-label"></label>
                  <div class="layui-input-block template-wrap">
                    <div id="chnlWrap"></div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="text-center">
      <button type="button" class="layui-btn nextPageBtn" onclick="nextPage()">继续</button>
      <button type="button" class="layui-btn layui-btn-primary step3Btn" style="display:none;">保存</button>
      <button type="button" class="layui-btn step3Btn" style="display:none;">提交</button>
    </div>
  </div>
  <script id="policyTemplate" type="text/html">
    <div class="layui-row">
      {{#  layui.each(d, function(index, item){ }}
      <div class="layui-col-md4 layui-col-sm4 policy-item">
        <input type="radio" name="policy" value="{{item.value}}" title="{{item.text}}">
      </div>
      {{#  }); }}
    </div>
  </script>
  <!-- 已有用户群模板 -->
  <script id="selectHtml" type="text/html">
    <div class="layui-row layui-col-space10">
      {{#  layui.each(d.list, function(index, item){ }}
      <div class="layui-col-md4 layui-col-sm4 layui-col-xs6">
        <div
          class="custGroupContent {{d.chooseCustID.indexOf(item.id)>-1?'active':''}} {{d.excludeCustID.indexOf(item.id)>-1?'exclude':''}}"
          onclick="chooseCust(this,'{{JSON.stringify(item).replace(/"/g, '&quot;')}}')">
          <p class="custTitle">{{item.title}}</p>
          <p class="custGroup-midWrap">
            <span class="custNum">{{item.num}}</span><span class="unit">人</span>
          </p>
          <p class="clearfix">
            <span class="custUser fl"><i class="layui-icon layui-icon-username"></i>{{item.user}}</span>
            <a class="fr" href="javascript:;" onclick="toDetailCust(this,'{{item.title}}')">详情></a>
          </p>
        </div>
      </div>
      {{#  }); }}
    </div>
  </script>
  <!-- 触点选择后 -->
  <script id="chnlTemplete" type="text/html">
    <!-- 短信 -->
    {{# if(d.type=='1'){ }}
  <div class="layui-form-item">
    <label class="layui-form-label">接触渠道模版：</label>
    <div class="layui-input-block choose-template-wrap">
      <textarea placeholder="请输入内容" name="prop" class="layui-textarea"></textarea>
      <button type="button" class="layui-btn" onclick="return false;"><i
          class="chooseMsg-icon"></i><span>选择模板</span></button>
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">短信接入号：</label>
    <div class="layui-input-inline">
      <select name="select5" id="select5"></select>
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">活动执行时间：</label>
    <div class="layui-inline">
      <div class="layui-input-inline">
        <input type="text" class="layui-input" id="startDate2" placeholder="HH:mm">
      </div>
      <div class="layui-form-mid">-</div>
      <div class="layui-input-inline">
        <input type="text" class="layui-input" id="endDate2" placeholder="HH:mm">
      </div>
    </div>
  </div>
  <!-- 人工外呼 -->
  {{# } else if(d.type=='2'){ }}
  <div class="layui-form-item">
    <label class="layui-form-label">有效间隔：</label>
    <div class="layui-inline">
      <div class="layui-input-inline">
        <input type="text" class="layui-input" id="startDate2" placeholder="HH:mm">
      </div>
      <div class="layui-form-mid">-</div>
      <div class="layui-input-inline">
        <input type="text" class="layui-input" id="endDate2" placeholder="HH:mm">
      </div>
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">剔除标准(天)：</label>
    <div class="layui-input-inline">
      <input type="text" class="layui-input">
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">任务周期：</label>
    <div class="layui-input-inline">
      <select name="select5" id="select5"></select>
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">短信类型：</label>
    <div class="layui-input-block box-radio">
      <input type="radio" name="smsType" value="1" title="短信" checked="">
      <input type="radio" name="smsType" value="2" title="外呼">
      <input type="radio" name="smsType" value="3" title="线上渠道">
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">短信内容：</label>
    <div class="layui-input-block choose-template-wrap">
      <textarea placeholder="请输入内容" name="prop" class="layui-textarea"></textarea>
      <button type="button" class="layui-btn" onclick="return false;"><i
          class="chooseMsg-icon"></i><span>选择模板</span></button>
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">是否搭车：</label>
    <div class="layui-input-block box-radio">
      <input type="radio" name="isDa" value="1" title="短信" checked="">
      <input type="radio" name="isDa" value="2" title="外呼">
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">搭车专项1：</label>
    <div class="layui-input-inline">
      <input type="text" class="layui-input">
    </div>
  </div>
  {{# } }}
  </script>
  <!-- 已选 -->
  <script id="choosedCustTemplate" type="text/html">
    <ul class="hasChoosedCustList">
      {{#  layui.each(d, function(index, item){ }}
      <li class="choosedItem">
        <span class="close layui-icon layui-icon-close" onclick="deleteChoosed('choosedCust','{{index}}')"></span>
        <p class="title">{{item.title}} </p>
        <p class="date">创建时间：{{item.date||''}}</p>
      </li>
      {{#  }); }}
    </ul>
  </script>
  <!-- 排除 -->
  <script id="excludeCustTemplate" type="text/html">
    <ul class="hasChoosedCustList">
      {{#  layui.each(d, function(index, item){ }}
      <li class="choosedItem">
        <span class="close layui-icon layui-icon-close" onclick="deleteChoosed('excludeCust','{{index}}')"></span>
        <p class="title">{{item.title}} </p>
        <p class="date">创建时间：{{item.date||''}}</p>
      </li>
      {{#  }); }}
    </ul>
  </script>
  <script src="../../assets/layui/layui.js"></script>
  <script>
    layui
      .config({
        base: '../../assets/' //静态资源所在路径
      })
      .use(['table', 'laytpl', 'laydate', 'form', 'laypage', 'element', 'upload'], function () {
        var $ = layui.$,
          table = layui.table,
          laydate = layui.laydate,
          form = layui.form,
          laytpl = layui.laytpl,
          element = layui.element,
          upload = layui.upload,
          laypage = layui.laypage;
        // 切换主Tab
        var pageTabIndex = 0;
        element.on('tab(pageTab)', function (data) {
          pageTabIndex = data.index;
          if (pageTabIndex == 0) {
            $('.nextPageBtn').show()
            $('.step3Btn').hide()
            renderPage1()
          } else if (pageTabIndex == 1) {
            $('.nextPageBtn').show()
            $('.step3Btn').hide()
            renderPage2()
          } else if (pageTabIndex == 2) {
            $('.nextPageBtn').hide()
            $('.step3Btn').show()
            renderPage3()
          }
        })
        // 继续
        window.nextPage = function () {
          element.tabChange('pageTab', (pageTabIndex + 1) + '');
        };
        $(function () {
          renderPage1()
        })
        /********************************************** 基本信息区域  **********************************************/
        //  渲染关联政策区域
        function rendPolicyWrap(page) {
          page = page || 1;

          function f(i) { //渲染政策单选区域
            var policyList = []
            //模拟假数据，实际ajax请求
            for (var i = 0; i < 15; i++) {
              policyList.push({
                value: i + '',
                text: '政策' + (Math.random() * 100).toFixed(0)
              })
            }
            var getTpl = policyTemplate.innerHTML,
              view = document.getElementById('choosePolicyWrap');
            laytpl(getTpl).render(policyList, function (html) {
              view.innerHTML = html;
              form.render()
            });
          }
          f(page)
          laypage.render({
            elem: 'policy-laypage',
            limit: 15,
            cur: page,
            count: 50,
            theme: 'common',
            prev: '<em class="layui-icon layui-icon-left"></em>',
            next: '<em class="layui-icon layui-icon-right"></em>',
            jump: function (obj, first) {
              if (!first) {
                f(obj.curr)
              }
            }
          });
        }

        function renderPage1() {
          rendPolicyWrap()
        }
        /********************************************** 目标客户群区域  **********************************************/
        // 已有用户群区域

        var choosedCustList = [],
          chooseCustID = [], //已选
          excludeCustList = [],
          excludeCustID = []; //排除
        var custTabIndex = 0;
        element.on('tab(choosedTab)', function (data) {
          custTabIndex = data.index;
        });

        function renderPage2() {
          laydate.render({
            elem: '#startDate21',
          })
          laydate.render({
            elem: '#endDate21',
          })
          laydate.render({
            elem: '#startDate22',
          })
          laydate.render({
            elem: '#endDate22',
          })
          upload.render({
            elem: '#uploadFile',
            // url: '/upload/',
            before: function (obj) {
              //预读本地文件示例，不支持ie8
              obj.preview(function (index, file, result) {
                console.log(file)
                // $('#demo1').attr('src', result); //图片链接（base64）
              });
            },
            done: function (res) {
              console.log(res)
            }
          });

          rendCustWrap()
          rendChooseWrap()
        }
        // 渲染已有客户群
        function rendCustWrap(page) {
          page = page || 1;

          function f(i) { //顾客群数据
            var randomData = []
            for (var m = 0; m < 15; m++) {
              randomData.push({
                "num": m,
                "user": "user-" + m,
                "title": "畅越" + m + "元档",
                "id": m + '',
                "date": '2019-12-12'
              })
            }

            var custData = {
              list: randomData,
              chooseCustID: chooseCustID,
              excludeCustID: excludeCustID
            }
            var getTpl = selectHtml.innerHTML,
              selectWrap = document.getElementById('selectWrap');
            laytpl(getTpl).render(custData, function (html) {
              selectWrap.innerHTML = html;
            });
          }
          f(page)
          laypage.render({
            elem: 'cust-laypage',
            limit: 15,
            cur: page,
            count: 50,
            theme: 'common',
            prev: '<em class="layui-icon layui-icon-left"></em>',
            next: '<em class="layui-icon layui-icon-right"></em>',
            jump: function (obj, first) {
              if (!first) {
                f(obj.curr)
              }
            }
          });
        }
        // 渲染右侧选择区域
        function rendChooseWrap() {
          var getTpl1 = choosedCustTemplate.innerHTML,
            selectWrap1 = document.getElementById('choosedCustWrap');
          laytpl(getTpl1).render(choosedCustList, function (html) {
            selectWrap1.innerHTML = html;
          });
          var getTpl2 = excludeCustTemplate.innerHTML,
            selectWrap2 = document.getElementById('excludeCustWrap');
          laytpl(getTpl2).render(excludeCustList, function (html) {
            selectWrap2.innerHTML = html;
          });
        }
        //点击客户群
        window.chooseCust = function (obj, data) {
          var custData = JSON.parse(data)
          if (custTabIndex == 0) {
            var index = chooseCustID.indexOf(custData.id);
            if (index > -1) {
              chooseCustID.splice(index, 1);
              choosedCustList.splice(index, 1)
            } else {
              chooseCustID.push(custData.id);
              choosedCustList.push(custData)
            }

          } else {
            var index = excludeCustID.indexOf(custData.id);
            if (index > -1) {
              excludeCustID.splice(index, 1);
              excludeCustList.splice(index, 1)
            } else {
              excludeCustID.push(custData.id);
              excludeCustList.push(custData)
            }
          }
          rendCustWrap()
          rendChooseWrap()
        }
        // 删除已选/排除
        window.deleteChoosed = function (tag, index) {
          if (tag == 'choosedCust') {
            chooseCustID.splice(index, 1);
            choosedCustList.splice(index, 1)
          } else if (tag == 'excludeCust') {
            excludeCustID.splice(index, 1);
            excludeCustList.splice(index, 1)
          }
          rendCustWrap()
          rendChooseWrap()
        }

        window.toDetailCust = function (obj, title) {
          event.stopPropagation();
          layer.open({
            title: title + '详情查看',
            content: title + '详情查看',
          });
        }
        /********************************************** 执行触点区域  **********************************************/
        //渲染不同触点类型配置区域
        function renderChnl(type) {
          var data = {
            type: type
          }
          var getTpl = chnlTemplete.innerHTML,
            selectWrap = document.getElementById('chnlWrap');
          laytpl(getTpl).render(data, function (html) {
            selectWrap.innerHTML = html;
            form.render()
          });
        }
        // 切换触点类型
        form.on('select(selectChnl)', function (obj) {
          renderChnl(obj.value)
        })

        function renderPage3() {
          laydate.render({
            elem: '#startDate',
          })
          laydate.render({
            elem: '#endDate',
          })
          laydate.render({
            elem: '#startDate2',
            type: 'time',
            format: 'HH:mm',
            theme: 'noSecond'
          });
          laydate.render({
            elem: '#endDate2',
            type: 'time',
            format: 'HH:mm',
            theme: 'noSecond'
          });
          renderChnl('1') //默认选中'短信'
        }
      })
  </script>
</body>

</html>