<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>话术详情</title>
  <link rel="stylesheet" href="../../assets/layui/css/layui.css" media="all" />
  <link rel="stylesheet" href="../../assets/style/index.css" media="all" />
  <link rel="stylesheet" href="../../assets/style/page.css" media="all" />
</head>

<body>
  <div class="layui-fluid common-page talkingPage">
    <div class="layui-card">
      <div class="layui-card-body">
        <div id="contentWrap"></div>
        <div id="processWrap"></div>

      </div>
    </div>
  </div>
  <script id="contentTemplate" type="text/html">
    <p class="page-title">{{d.templateName}}</p>
    <div>{{d.templateHead}}</div>
    <form class="layui-form contentWrap" lay-filter="templateForm">
      {{#  layui.each(d.contentData, function(index, item){ }}
      <div class="layui-form-item level1-item">
        <label
          class="layui-form-label {{item.isRequired=='true'?'layui-required':''}}">{{index+1}}、{{item.itemDesc}}</label>
        {{# if(item.itemType=='radio'){ }}
        <div class="layui-input-block ">
          {{#  layui.each(item.options, function(i, obj){ }}
          <input type="radio" name="{{item.itemId}}" value="{{obj.optionId}}" title="{{obj.optionDesc}}"
            data-itemid="{{item.itemId}}" />
          {{#  }); }}
        </div>
        {{# }else if(item.itemType=='checkbox'){ }}
        <div class=" layui-input-block ">
          {{#  layui.each(item.options, function(i, obj){ }}
          <input type="checkbox" name="{{item.itemId}}" value="{{obj.optionId}}" lay-skin="primary"
            title="{{obj.optionDesc}}" data-itemid="{{item.itemId}}" />
          {{#  }); }}
        </div>
        {{# }else if(item.itemType=='select'){ }}
        <div class="layui-input-block ">
          <select data-itemid="{{item.itemId}}" name="{{item.itemId}}">
            <option value="">请选择</option>
            {{#  layui.each(item.options, function(i, obj){ }}
            <option value="{{obj.optionId}}">{{obj.optionDesc}}</option>
            {{#  }); }}
          </select>
        </div>
        {{# }else if(item.itemType=='input'){ }}
        <div class=" layui-input-block ">
          <input type="text" class="layui-input" name="{{item.itemId}}" onblur="changeInput(this,'{{item.itemId}}')">
        </div>
        {{# }else if(item.itemType=='textarea'||item.itemType=='desc'){ }}
        <div class=" layui-input-block ">
          <textarea class="layui-textarea" name="{{item.itemId}}"
            onblur="changeInput(this,'{{item.itemId}}')"></textarea>
        </div>
        {{# } }}
        <div id="childWrap{{item.itemId}}" parentIndex="{{index+1}}" class="childWrap"></div>
      </div>

      {{#  }); }}
    </form>
    <div>{{d.templateEnd}}</div>
  </script>
  <script id="childTemplate" type="text/html">
    {{#  layui.each(d.list, function(index, item){ }}
    <div class="layui-form-item ">
      <label
        class="layui-form-label {{item.isRequired=='true'?'layui-required':''}}">{{d.parentIndex}}.{{index+1}}、{{item.itemDesc}}</label>
      {{# if(item.itemType=='radio'){ }}
      <div class="layui-input-block ">
        {{#  layui.each(item.options, function(i, obj){ }}
        <input type="radio" name="{{item.itemId}}" value="{{obj.optionId}}" title="{{obj.optionDesc}}"
          data-itemid="{{item.itemId}}" />
        {{#  }); }}
      </div>
      {{# }else if(item.itemType=='checkbox'){ }}
      <div class=" layui-input-block ">
        {{#  layui.each(item.options, function(i, obj){ }}
        <input type="checkbox" name="{{item.itemId}}[{{obj.optionId}}]" value="{{obj.optionId}}" lay-skin="primary"
          title="{{obj.optionDesc}}" data-itemid="{{item.itemId}}" />
        {{#  }); }}
      </div>
      {{# }else if(item.itemType=='select'){ }}
      <div class="layui-input-block ">
        <select data-itemid="{{item.itemId}}" name="{{item.itemId}}">
          <option value="">请选择</option>
          {{#  layui.each(item.options, function(i, obj){ }}
          <option value="{{obj.optionId}}">{{obj.optionDesc}}</option>
          {{#  }); }}
        </select>
      </div>
      {{# }else if(item.itemType=='input'){ }}
      <div class=" layui-input-block ">
        <input type="text" class="layui-input" name="{{item.itemId}}" onblur="changeInput(this,'{{item.itemId}}')">
      </div>
      {{# }else if(item.itemType=='textarea'||item.itemType=='desc'){ }}
      <div class=" layui-input-block ">
        <textarea class="layui-textarea" name="{{item.itemId}}" onblur="changeInput(this,'{{item.itemId}}')"></textarea>
      </div>
      {{# } }}
    </div>
    {{#  }); }}
  </script>
  <script id="processTemplate" type="text/html">
    <div class="progress-wrap clearfix">
      <span class="fl">问题完成进度({{d.num}}/{{d.total}})：</span>
      <div class="layui-progress fl" lay-filter="doPer">
        <div class="layui-progress-bar layui-bg-orange" lay-percent="{{d.percent}}"></div>
      </div>
      <span class="fl">{{d.percent}}</span>
    </div>
  </script>

  <script src="../../assets/layui/layui.js"></script>
  <script>
    layui
      .config({
        base: '../../assets/' //静态资源所在路径
      })
      .use(['laydate', 'form', 'layer', 'laytpl', 'element'], function () {
        var $ = layui.$,
          laydate = layui.laydate,
          form = layui.form,
          layer = layui.layer,
          laytpl = layui.laytpl,
          element = layui.element;
        var templateData = {},
          answerData = {}
        // 将问题的转换成树形结构，方便显/隐展示
        function buildTreeData(list) {
          let temp = {};
          let tree = {};
          let arr = []
          for (let i in list) {
            temp[list[i].itemId] = list[i];
          }
          for (let i in temp) {
            if (temp[i].dependItemCode) {
              if (!temp[temp[i].dependItemCode].children) {
                temp[temp[i].dependItemCode].children = [];
              }
              temp[temp[i].dependItemCode].children.push(temp[i]);
            } else {
              tree[temp[i].itemId] = temp[i];
            }
          }
          for (let i in tree) {
            arr.push(tree[i])
          }
          return arr;
        }
        //获取数据
        function getData() {
          templateData = {
            "createDate": 1578067200000,
            "creater": "SUPERUSER",
            "eparchCode": "0020",
            "saleType": "",
            "templateCode": 1000030,
            "templateContent": [{
                "createStaffId": "SUPERUSER",
                "dependItemCode": "",
                "dependOptionId": "",
                "eparchyCode": "0020",
                "isRequired": "true",
                "itemCode": "1",
                "itemDesc": "话术模板新增问题",
                "itemGrade": "1",
                "itemId": 1000020,
                "itemStatus": "1",
                "itemType": "radio",
                "options": [{
                  "itemId": 1000020,
                  "optionDesc": "话术模板新增问题选项1",
                  "optionId": 0
                }, {
                  "itemId": 1000020,
                  "optionDesc": "话术模板新增问题选项2",
                  "optionId": 1
                }],
                "templateCode": 1000037
              }, {
                "createStaffId": "SUPERUSER",
                "dependItemCode": "1000020",
                "dependOptionId": "0",
                "eparchyCode": "0020",
                "isRequired": "false",
                "itemCode": "1-1",
                "itemDesc": "话术模板新增问题2",
                "itemGrade": "2",
                "itemId": 1000021,
                "itemStatus": "1",
                "itemType": "checkbox",
                "options": [{
                  "itemId": 1000021,
                  "optionDesc": "话术模板新增问题2选项1",
                  "optionId": 0
                }, {
                  "itemId": 1000021,
                  "optionDesc": "话术模板新增问题2选项2",
                  "optionId": 1
                }],
                "templateCode": 1000037
              },
              {
                "createStaffId": "SUPERUSER",
                "dependItemCode": "1000020",
                "dependOptionId": "0",
                "eparchyCode": "0020",
                "isRequired": "false",
                "itemCode": "1-2",
                "itemDesc": "话术模板新增问题3",
                "itemGrade": "2",
                "itemId": 1000022,
                "itemStatus": "1",
                "itemType": "input",
                "templateCode": 1000037
              }, {
                "createStaffId": "SUPERUSER",
                "dependItemCode": "",
                "dependOptionId": "",
                "eparchyCode": "0020",
                "isRequired": "true",
                "itemCode": "2",
                "itemDesc": "话术模板新增问题4",
                "itemGrade": "1",
                "itemId": 10000203,
                "itemStatus": "1",
                "itemType": "checkbox",
                "options": [{
                  "itemId": 1000020,
                  "optionDesc": "话术模板新增问题选项1",
                  "optionId": 0
                }, {
                  "itemId": 1000020,
                  "optionDesc": "话术模板新增问题选项2",
                  "optionId": 1
                }],
                "templateCode": 1000037
              },
              {
                "createStaffId": "SUPERUSER",
                "dependItemCode": "",
                "dependOptionId": "",
                "eparchyCode": "0020",
                "isRequired": "true",
                "itemCode": "3",
                "itemDesc": "话术模板新增问题3",
                "itemGrade": "1",
                "itemId": 100002011,
                "itemStatus": "1",
                "itemType": "input",

                "templateCode": 1000037
              }
            ],
            "templateEnd": "<p><u>测试新增</u></p>",
            "templateHead": "<p><u>测试新增</u></p>",
            "templateName": "测试新增",
            "templateState": "2",
            "updateDate": 1578067200000
          }
          //问题列表，模拟数据
          // templateData.contentData = buildTreeData(JSON.parse(templateData.templateContent))
          templateData.contentData = buildTreeData(templateData.templateContent)
        }
        // 渲染问题区域
        function renderContent() {
          var getTpl = contentTemplate.innerHTML,
            selectWrap = document.getElementById('contentWrap');
          laytpl(getTpl).render(templateData, function (html) {
            selectWrap.innerHTML = html;
            form.render()
            element.render()

          });
        }
        // 渲染二级问题区域
        function renderChildContent(data, code) {
          var getTpl = childTemplate.innerHTML,
            selectWrap = document.getElementById('childWrap' + code);
          var renderData = {
            list: data,
            parentIndex: $(selectWrap).attr('parentIndex')
          }
          laytpl(getTpl).render(renderData, function (html) {
            selectWrap.innerHTML = html;
            form.render()
          });
        }

        form.on('select', function (data) {
          var code = $(data.elem).data('itemid')
          renderChild(code, [data.value])
          answerData[code] = data.value
          getProgress()

        });
        var checkboxArr = {}
        form.on('checkbox', function (data) {
          var code = $(data.elem).data('itemid')
          if (!checkboxArr[code]) {
            checkboxArr[code] = []
          }
          if (data.elem.checked) {
            checkboxArr[code].push(data.value)
          } else {
            checkboxArr[code].splice(checkboxArr[code].indexOf(data.value), 1)
          }
          renderChild(code, checkboxArr[code])
          answerData[code] = checkboxArr[code]
          getProgress()
        });
        form.on('radio', function (data) {
          var code = $(data.elem).data('itemid')
          renderChild(code, [data.value])
          answerData[code] = data.value
          getProgress()
        });
        //渲染二级问题
        function renderChild(code, valArr) {
          for (var i = 0; i < templateData.contentData.length; i++) {
            if (templateData.contentData[i].itemId == code) {
              var arr = []
              if (templateData.contentData[i].children) {
                for (var j = 0; j < templateData.contentData[i].children.length; j++) {
                  if (valArr.indexOf(templateData.contentData[i].children[j].dependOptionId) > -1) {
                    arr.push(templateData.contentData[i].children[j])
                  }
                }
                renderChildContent(arr, code)
                return
              }
            }
          }
        }

        // 输入框交互
        window.changeInput = function (obj, code) {
          answerData[code] = $(obj).val()
          getProgress()
        }
        // 获取答案数据，并计算进度
        function getProgress() {
          var num = 0,
            total = templateData.contentData.length
          for (var i = 0; i < total; i++) {
            if (judgeData(answerData[templateData.contentData[i].itemId])) {
              num++
            }
          }
          var getTpl = processTemplate.innerHTML,
            selectWrap = document.getElementById('processWrap');
          var renderData = {
            num: num,
            total: total,
            percent: parseInt(num * 100 / total) + '%'
          }
          laytpl(getTpl).render(renderData, function (html) {
            selectWrap.innerHTML = html;
            element.render()
          });
        }

        function judgeData(data) {
          if (data == null || data == undefined || data.length == 0 || data.length == '') {
            return false
          } else {
            return true
          }
        }
        $(function () {
          getData()
          renderContent()
          getProgress()
        })
      })
  </script>
</body>

</html>